export class SearchSelect{constructor(e){this.selectElement=e,this.options=this.getOptionsItems(),this.selectedOption=this.options.find((e=>e.selected)),this.highlightedIndex=-1,this.searchSelectContainer=document.createElement("div"),this.searchSelectContainer.classList.add("search-select-container"),this.displayElement=document.createElement("div"),this.displayElement.classList.add("search-select-display"),this.displayElement.setAttribute("tabindex","0"),this.displayElement.setAttribute("role","combobox"),this.displayElement.setAttribute("aria-haspopup","listbox"),this.displayElement.setAttribute("aria-expanded","false"),this.updateDisplay(),this.dropdownElement=document.createElement("div"),this.dropdownElement.classList.add("search-select-dropdown"),this.dropdownElement.setAttribute("role","listbox"),this.searchContainer=document.createElement("div"),this.searchContainer.classList.add("search-select-search"),this.searchInput=document.createElement("input"),this.searchInput.setAttribute("type","text"),this.searchInput.setAttribute("placeholder","Search.."),this.searchInput.setAttribute("aria-label","Search options"),this.searchInput.classList.add("form-control"),this.searchContainer.appendChild(this.searchInput),this.dropdownElement.appendChild(this.searchContainer),this.optionsListElement=document.createElement("ul"),this.optionsListElement.classList.add("search-select-options"),this.optionsListElement.setAttribute("role","presentation"),this.dropdownElement.appendChild(this.optionsListElement),this.buildOptions(),this.searchSelectContainer.appendChild(this.displayElement),this.searchSelectContainer.appendChild(this.dropdownElement),this.selectElement.parentNode.insertBefore(this.searchSelectContainer,this.selectElement),this.selectElement.classList.add("search-select-hidden"),this.selectElement.setAttribute("tabindex","-1"),this.selectElement.setAttribute("aria-hidden","true"),this.addEventListeners()}getOptionsItems(){return Array.from(this.selectElement.options).map(((e,t)=>({value:e.value,label:e.label||e.textContent,selected:e.selected,disabled:e.disabled,element:e,id:`search-select-option-${this.selectElement.id||Math.random().toString(36).substring(2)}-${t}`})))}buildOptions(){this.optionsListElement.innerHTML="",this.options.forEach(((e,t)=>{const s=document.createElement("li");s.classList.add("search-select-option"),s.textContent=e.label,s.dataset.value=e.value,s.setAttribute("role","option"),s.setAttribute("id",e.id),s.setAttribute("aria-selected",e.selected?"true":"false"),e.disabled&&(s.classList.add("disabled"),s.setAttribute("aria-disabled","true")),e.selected&&(s.classList.add("selected"),this.highlightedIndex=t),e.searchElement=s,this.optionsListElement.appendChild(s),e.disabled||(s.addEventListener("click",(()=>{this.selectOption(e),this.closeDropdown()})),s.addEventListener("mouseenter",(()=>{this.highlightOption(t)})))}))}updateDisplay(){if(this.selectedOption&&this.selectedOption.value)this.displayElement.textContent=this.selectedOption.label,this.displayElement.classList.remove("placeholder"),this.displayElement.setAttribute("aria-activedescendant",this.selectedOption.id);else{const e=""===this.selectElement.options[0]?.value?this.selectElement.options[0].textContent:"Select an option...";this.displayElement.textContent=e,this.displayElement.classList.add("placeholder"),this.displayElement.removeAttribute("aria-activedescendant")}}selectOption(e){if(e.disabled)return;if(!e.element){const t=this.options.find((t=>t.value===e.value));if(!t)return;e=t}const t=this.options.find((e=>e.selected));t&&(t.selected=!1,t.element.selected=!1,t.searchElement&&(t.searchElement.classList.remove("selected"),t.searchElement.setAttribute("aria-selected","false"))),e.selected=!0,e.element.selected=!0,this.selectedOption=e,e.searchElement&&(e.searchElement.classList.add("selected"),e.searchElement.setAttribute("aria-selected","true")),this.updateDisplay(),this.selectElement.dispatchEvent(new Event("change",{bubbles:!0}))}toggleDropdown(){this.dropdownElement.classList.contains("show")?this.closeDropdown():this.openDropdown()}openDropdown(){document.querySelectorAll(".search-select-dropdown.show").forEach((e=>{if(e!==this.dropdownElement){e.classList.remove("show");const t=e.previousElementSibling;t&&t.classList.contains("search-select-display")&&(t.classList.remove("open"),t.setAttribute("aria-expanded","false"))}})),this.dropdownElement.classList.add("show"),this.displayElement.classList.add("open"),this.displayElement.setAttribute("aria-expanded","true"),this.searchInput.focus(),this.resetHighlight(),this.scrollToHighlightedOption()}closeDropdown(){this.dropdownElement.classList.remove("show"),this.displayElement.classList.remove("open"),this.displayElement.setAttribute("aria-expanded","false"),this.searchInput.value="",this.filterOptions(""),this.resetHighlight(),this.displayElement.focus()}filterOptions(e){const t=e.toLowerCase().trim();let s=-1;this.options.forEach(((e,i)=>{const n=e.label.toLowerCase().includes(t);e.hidden=!n,e.searchElement&&e.searchElement.classList.toggle("hidden",!n),n&&-1===s&&!e.disabled&&(s=i)})),this.highlightOption(s)}highlightOption(e){const t=this.optionsListElement.querySelector(".highlighted");t&&t.classList.remove("highlighted");const s=this.options.filter((e=>!e.hidden&&!e.disabled));if(0===s.length)return this.highlightedIndex=-1,void this.displayElement.removeAttribute("aria-activedescendant");let i=-1;if(-1!==e){const t=this.options[e];i=!t||t.hidden||t.disabled?0:s.findIndex((e=>e===t))}if(-1!==i){const e=s[i];e&&e.searchElement?(e.searchElement.classList.add("highlighted"),this.highlightedIndex=this.options.indexOf(e),this.displayElement.setAttribute("aria-activedescendant",e.id),this.scrollToHighlightedOption()):(this.highlightedIndex=-1,this.displayElement.removeAttribute("aria-activedescendant"))}else this.highlightedIndex=-1,this.displayElement.removeAttribute("aria-activedescendant")}resetHighlight(){const e=this.optionsListElement.querySelector(".highlighted");e&&e.classList.remove("highlighted");const t=this.options.findIndex((e=>e.selected&&!e.hidden&&!e.disabled));this.highlightedIndex=t,-1!==t?this.highlightOption(t):this.displayElement.removeAttribute("aria-activedescendant")}scrollToHighlightedOption(){if(-1===this.highlightedIndex)return;const e=this.options[this.highlightedIndex]?.searchElement;if(e){const t=this.dropdownElement.getBoundingClientRect(),s=e.getBoundingClientRect();s.bottom>t.bottom?this.dropdownElement.scrollTop+=s.bottom-t.bottom:s.top<t.top+this.searchContainer.offsetHeight&&(this.dropdownElement.scrollTop-=t.top+this.searchContainer.offsetHeight-s.top)}}handleKeyboard(e){if(!this.dropdownElement.classList.contains("show"))return void("Enter"!==e.key&&" "!==e.key||document.activeElement!==this.displayElement||(e.preventDefault(),this.openDropdown()));const t=this.options.filter((e=>!e.hidden&&!e.disabled));if(0===t.length&&"Escape"!==e.key)return;let s=-1;switch(-1!==this.highlightedIndex&&(s=t.findIndex((e=>this.options.indexOf(e)===this.highlightedIndex))),e.key){case"ArrowDown":{e.preventDefault();const i=(s+1)%t.length;this.highlightOption(this.options.indexOf(t[i]));break}case"ArrowUp":{e.preventDefault();const i=(s-1+t.length)%t.length;this.highlightOption(this.options.indexOf(t[i]));break}case"Enter":case" ":if(e.preventDefault(),-1!==this.highlightedIndex){const e=this.options[this.highlightedIndex];e&&!e.disabled&&(this.selectOption(e),this.closeDropdown())}break;case"Escape":e.preventDefault(),this.closeDropdown();break;case"Tab":this.closeDropdown();break;case"Home":e.preventDefault(),t.length>0&&this.highlightOption(this.options.indexOf(t[0]));break;case"End":e.preventDefault(),t.length>0&&this.highlightOption(this.options.indexOf(t[t.length-1]))}}addEventListeners(){this.displayElement.addEventListener("click",(e=>{e.stopPropagation(),this.toggleDropdown()})),this.displayElement.addEventListener("keydown",(e=>{if("Enter"===e.key||" "===e.key||"ArrowDown"===e.key||"ArrowUp"===e.key)if(e.preventDefault(),this.openDropdown(),"ArrowDown"===e.key)this.highlightOption(this.options.findIndex((e=>!e.hidden&&!e.disabled)));else if("ArrowUp"===e.key){const e=this.options.filter((e=>!e.hidden&&!e.disabled));this.highlightOption(this.options.indexOf(e[e.length-1]))}})),document.addEventListener("click",(e=>{!this.searchSelectContainer.contains(e.target)&&this.dropdownElement.classList.contains("show")&&this.closeDropdown()})),this.searchInput.addEventListener("input",(()=>{this.filterOptions(this.searchInput.value)})),this.dropdownElement.addEventListener("click",(e=>{e.stopPropagation()})),this.searchSelectContainer.addEventListener("keydown",this.handleKeyboard.bind(this));const e=new MutationObserver((e=>{let t=e.some((e=>"childList"===e.type)),s=e.some((e=>"attributes"===e.type&&"selected"===e.attributeName&&"OPTION"===e.target.tagName));(t||s)&&(this.options=this.getOptionsItems(),this.selectedOption=this.options.find((e=>e.selected)),this.buildOptions(),this.updateDisplay(),this.dropdownElement.classList.contains("show")&&(this.filterOptions(this.searchInput.value),this.resetHighlight()))}));e.observe(this.selectElement,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["selected","disabled","value","label"]}),this.mutationObserver=e}remove(){this.mutationObserver&&this.mutationObserver.disconnect(),this.searchSelectContainer.parentNode&&this.searchSelectContainer.parentNode.removeChild(this.searchSelectContainer),this.selectElement.classList.remove("search-select-hidden"),this.selectElement.removeAttribute("tabindex"),this.selectElement.removeAttribute("aria-hidden")}}